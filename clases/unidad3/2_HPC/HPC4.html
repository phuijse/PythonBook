
<!DOCTYPE html>

<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>4. Acelerando Python con Cython &#8212; INFO147 Computación científica con Python</title>
    
  <link rel="stylesheet" href="../../../_static/css/index.f658d18f9b420779cfdf24aa0a7e2d77.css">

    
  <link rel="stylesheet"
    href="../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      
  <link rel="stylesheet"
    href="../../../_static/vendor/open-sans_all/1.44.1/index.css">
  <link rel="stylesheet"
    href="../../../_static/vendor/lato_latin-ext/1.44.1/index.css">

    
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/sphinx-book-theme.c441f2ba0852f4cabcb80105e3a46ae6.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../../../_static/js/index.d3f166471bb80abb5163.js">

    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/togglebutton.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script src="../../../_static/translations.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../../_static/sphinx-book-theme.7d483ff0a819d6edff12ce0b1ead3928.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.0/dist/embed-amd.js"></script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../../../_static/sphinx-thebe.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    <link rel="index" title="Índice" href="../../../genindex.html" />
    <link rel="search" title="Búsqueda" href="../../../search.html" />
    <link rel="next" title="5. Computación paralela en Python" href="HPC5.html" />
    <link rel="prev" title="3. Optimizando código Python" href="HPC3.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />



  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="../../../index.html">
  
  <img src="../../../_static/logo.png" class="logo" alt="logo">
  
  
  <h1 class="site-logo" id="site-title">INFO147 Computación científica con Python</h1>
  
</a>
</div><form class="bd-search d-flex align-items-center" action="../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Buscar este libro ..." aria-label="Buscar este libro ..." autocomplete="off" >
</form>
<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <p class="caption collapsible-parent">
 <span class="caption-text">
  Manipulación de datos
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../../unidad1/01_introduccion.html">
   1. Introducción: Computación científica y ciencia de datos
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../unidad1/02_ambientes_virtuales.html">
   2. Ambientes virtuales de Python
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../unidad1/04_jupyter_y_ipython.html">
   3. Jupyter y IPython
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../unidad1/05_numpy.html">
   4. Arreglos y operaciones vectoriales con NumPy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../unidad1/06_matplotlib.html">
   5. Visualización de datos usando Matplotlib
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../unidad1/07_pandas_b%C3%A1sico.html">
   6. Procesamiento de datos con
   <em>
    pandas
   </em>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../unidad1/08_pandas_avanzado.html">
   7. Exploración y manipulación de datos con
   <code class="docutils literal notranslate">
    <span class="pre">
     pandas
    </span>
   </code>
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  Computación científica
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../../unidad2/1_linearalgebra/1_linear_algebra.html">
   1. Algebra lineal con NumPy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../unidad2/1_linearalgebra/2_linear_regression.html">
   2. Regresión lineal, Sobreajuste y Validación
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../unidad2/2_calculus/optimization.html">
   3. Optimización matemática
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../unidad2/3_statistics/stats1.html">
   4. Estadística: Fundamentos
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../unidad2/3_statistics/stats2.html">
   5. Estadística descriptiva
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../unidad2/3_statistics/stats3.html">
   6. Estadística inferencial
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  Aprendizaje de máquinas
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../1_ML/ML1.html">
   1. Machine Learning: Conceptos clave
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../1_ML/ML2.html">
   2. Aprendizaje supervisado: Clasificación
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../1_ML/ML3.html">
   3. Aprendizaje no supervisado
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  Computación de alto rendimiento
 </span>
</p>
<ul class="current nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="HPC1.html">
   1. Introducción: Python y  Rendimiento
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="HPC2.html">
   2. Profiling
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="HPC3.html">
   3. Optimizando código Python
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   4. Acelerando Python con Cython
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="HPC5.html">
   5. Computación paralela en Python
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  Anexos
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../../unidad1/00_repaso_python3.html">
   1. Repaso de Python 3
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../unidad1/03_control_de_versiones.html">
   2. Control de versiones
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../unidad1/10_pandas_anexos.html">
   3. Pandas: Tópicos extra
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../unidad1/09_interfaces_de_usuario.html">
   4. Interfaces de usuario en Jupyter con
   <code class="docutils literal notranslate">
    <span class="pre">
     ipywidgets
    </span>
   </code>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../unidad1/11_ipython_display.html">
   5. Módulo
   <code class="docutils literal notranslate">
    <span class="pre">
     IPython.display
    </span>
   </code>
  </a>
 </li>
</ul>

</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Navegación de palanca" aria-controls="site-navigation"
                title="Navegación de palanca" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Descarga esta pagina"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../../../_sources/clases/unidad3/2_HPC/HPC4.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Descargar archivo fuente" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Imprimir en PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->


            <!-- Full screen (wrap in <a> to have style consistency -->
            <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
                    data-placement="bottom" onclick="toggleFullScreen()" aria-label="Modo de pantalla completa"
                    title="Modo de pantalla completa"><i
                        class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/magister-informatica-uach/INFO147/master?urlpath=tree/clases/unidad3/2_HPC/HPC4.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Lanzamiento Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../../../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
        <div class="tocsection onthispage pt-5 pb-3">
            <i class="fas fa-list"></i>
            Contenido
        </div>
        <nav id="bd-toc-nav">
            <ul class="nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#cython-c-extensions-for-python">
   4.1. Cython: C Extensions for Python
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#cython-desde-ipython">
   4.2. Cython desde IPython
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#mejora-1-definiendo-tipos-en-cython">
   4.3. Mejora 1: Definiendo tipos en Cython
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#mejora-2-llamando-funciones-de-c-desde-cython">
   4.4. Mejora 2: Llamando funciones de C desde Cython
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#mejora-3-deshabilitando-comprobaciones-para-ir-aun-mas-rapido">
   4.5. Mejora 3: Deshabilitando comprobaciones para ir aun más rápido
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#mejora-4-mayor-flexibilidad-con-tipos-de-cython-fusionados">
   4.6. Mejora 4: Mayor flexibilidad con tipos de Cython fusionados
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#ejemplo-formativo-cythonizando-el-fractal-de-julia">
   4.7. Ejemplo formativo: “Cythonizando” el fractal de Julia
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#topicos-adicionales">
   4.8. Tópicos adicionales
  </a>
 </li>
</ul>

        </nav>
        
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">YouTubeVideo</span><span class="p">,</span> <span class="n">Markdown</span><span class="p">,</span> <span class="n">SVG</span><span class="p">,</span> <span class="n">Code</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="n">YouTubeVideo_formato</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">YouTubeVideo</span><span class="p">,</span> <span class="n">modestbranding</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">disablekb</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                               <span class="n">width</span><span class="o">=</span><span class="mi">640</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">360</span><span class="p">,</span> <span class="n">autoplay</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">rel</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">showinfo</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="acelerando-python-con-cython">
<h1><span class="section-number">4. </span>Acelerando Python con Cython<a class="headerlink" href="#acelerando-python-con-cython" title="Enlazar permanentemente con este título">¶</a></h1>
<p>La <a class="reference external" href="https://wiki.python.org/moin/PythonImplementations">implementación</a> más utilizada del interprete/compilador de Python está escrita en C y se llama <a class="reference external" href="https://github.com/python/cpython">CPython</a>. Recordemos que la implementación es aquello que interpreta y corre el código escrito en Python. Existen otras implementaciones de Python menos usadas como <a class="reference external" href="https://www.pypy.org/">PyPy</a>, <a class="reference external" href="https://www.jython.org/">Jython</a> o IronPython.</p>
<p>CPython compila el código escrito en Python en un código de máquina (binario) de forma transparente al usuario. Luego CPython interpreta el binario. Si nos interesa, podemos estudiar dicho código binario usando el módulo <a class="reference external" href="https://docs.python.org/3.7/library/dis.html">dis</a> de Python</p>
<p>Luego, si sabemos C podemos usar la <a class="reference external" href="https://docs.python.org/3/c-api/index.html">API de Python/C</a> para</p>
<ol class="simple">
<li><p>Escribir módulos de C que puedan llamarse desde Python</p></li>
<li><p>Hacer interfaces entre código C y Python</p></li>
</ol>
<p>Sin embargo la API es un poco complicada y existen alternativas menos tediosas para lograr estos objetivos, como por ejemplo</p>
<ul class="simple">
<li><p><a class="reference external" href="https://docs.python.org/2/library/ctypes.html">ctypes</a></p></li>
<li><p><a class="reference external" href="https://cffi.readthedocs.io/en/latest/">CFFI</a></p></li>
<li><p><a class="reference external" href="http://swig.org/">SWIG</a></p></li>
<li><p>Cython</p></li>
</ul>
<p>En esta lección veremos en detalle esta última</p>
<div class="section" id="cython-c-extensions-for-python">
<h2><span class="section-number">4.1. </span><a class="reference external" href="https://cython.org/">Cython</a>: C Extensions for Python<a class="headerlink" href="#cython-c-extensions-for-python" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Recordemos que <strong>Python</strong> es un lenguaje interpretado con tipos dinámicos. Esto hace que cada operación tenga un overhead. Por ejemplo</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="n">z</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
    <span class="c1"># overhead: Inferir el tipo de x</span>
    <span class="c1"># overhead: Inferir el tipo de y</span>
    <span class="c1"># Hacer la operación suma</span>
    <span class="c1"># overhead: Darle el tipo adecuado a z</span>
</pre></div>
</div>
<p>en cambio, <strong>Cython</strong> es un lenguaje de programación que le agrega a Python algunas propiedades de C y C++, una de ellas son los <strong>tipos estáticos</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="nb">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="nb">int</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="nb">int</span> <span class="n">z</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
    <span class="c1"># No hay que inferir el tipo de x, y, z</span>
</pre></div>
</div>
<p>Esto hace que Cython sea menos flexible pero decenas de veces más rápido que Python. Además en términos de sintaxis Cython es casi tan simple como Python. Sin embargo a diferencia de Python, el lenguaje Cython debe compilarse</p>
<ul class="simple">
<li><p>El compilador de Cython convierte el código fuente en código C</p></li>
<li><p>Luego el código C se compila como un módulo de Python con la implementación <strong>CPython</strong></p></li>
</ul>
<p>En pocas palabras, una vez compilado el código escrito en Cython este puede llamarse desde Python!</p>
<p>¿Por qué considerar Cython?</p>
<ul class="simple">
<li><p>Cython es casi tan simple como Python y casi tan rápido como C</p></li>
<li><p>Con Cython se pueden llamar funciones y librerías de C</p></li>
<li><p>Cython se integra de buena manera con NumPy</p></li>
</ul>
<p>Por ende Cython es muy atractivo para proyectos que usen Python y tengan requisitos de alto rendimiento. Estudiemos la sintaxis de Cython mediante algunos ejemplos</p>
<p>A lo largo de esta lección usaremos como ejemplo el cálculo de la <strong>Distancia euclidiana todos-con-todos</strong>. Sea un conjunto de <span class="math notranslate nohighlight">\(N=1000\)</span> datos bidimensionales (<span class="math notranslate nohighlight">\(D=2\)</span>) donde queremos calcular la distancia euclidiana de cada dato con todos los demás, es decir una matriz donde el elemento <span class="math notranslate nohighlight">\(ij\)</span> es</p>
<div class="math notranslate nohighlight">
\[
\text{dist}_{ij} = \sqrt {\sum_{k=1}^D (x_{ik} - x_{jk})^2}
\]</div>
<p>A continuación se muestran dos códigos que cumplen este proposito y obtienen un resultado equivalente</p>
<ul class="simple">
<li><p>El primero usa “Python puro” y calcula las distancias de forma secuencial</p></li>
<li><p>El segundo usa operaciones vectoriales de NumPy y calcula las distancias “al mismo tiempo”</p></li>
</ul>
<p>Estudie ambos códigos hasta comprenderlos</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">distancia_pares</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>    
    <span class="n">N</span><span class="p">,</span> <span class="n">D</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
            <span class="n">dist</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">D</span><span class="p">):</span>
                <span class="n">dist</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">dist</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dist</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>
            <span class="n">dist</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">dist</span>
            
<span class="k">def</span> <span class="nf">distancia_pares_numpy</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>

<span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">distancia_pares</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">distancia_pares_numpy</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">timeit</span> -r3 -n1 distancia_pares(data)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4 s ± 9.52 ms per loop (mean ± std. dev. of 3 runs, 1 loop each)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">timeit</span> -r3 -n1 distancia_pares_numpy(data)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>43.6 ms ± 4.8 ms per loop (mean ± std. dev. of 3 runs, 1 loop each)
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="cython-desde-ipython">
<h2><span class="section-number">4.2. </span>Cython desde IPython<a class="headerlink" href="#cython-desde-ipython" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Primero debemos instalar cython en nuestro ambiente de conda</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>conda install cython
</pre></div>
</div>
<p>Luego en IPython podemos cargar la extensión <code class="docutils literal notranslate"><span class="pre">cython</span></code> como se muestra a continuación</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> cython
</pre></div>
</div>
</div>
</div>
<p>con esto tendremos disponible la magia de bloque <code class="docutils literal notranslate"><span class="pre">%%cython</span></code></p>
<p>Un bloque donde se use esta magia acepta lenguaje cython y se compila al ejecutarlo. Luego podremos llamar las funciones de ese bloque desde bloques regulares de Python</p>
<p>Si surgen errores de compulación estos aparecen como la salida del bloque. Notar que este bloque está “desconectado” del resto del notebook, por lo que debe tener sus propios <code class="docutils literal notranslate"><span class="pre">import</span></code></p>
<p>La magia tiene las siguientes opciones</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">-a</span></code> (annotate) retorna un profile linea a linea indicando con amarillo las llamadas a CPython (mientras más llamadas más lento es nuestro código)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-+</span></code> Usar C++ en lugar de C</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-c</span></code> Argumentos de compilación</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-l</span></code> librerías para linkear a nuestro código</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-L</span></code> directorio con librerías</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-I</span></code> directorio con cabeceras (include)</p></li>
</ul>
<p>Veamos que ocurre al agregarle la magia al ejemplo anterior</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">cython</span>

import numpy as np

def distancia_pares_cython_inocente(data):    
    N, D = data.shape
    dist = np.empty(shape=(N, N))
    for i in range(N):
        for j in range(i, N):
            dist[i, j] = 0.0
            for k in range(D):
                dist[i, j] += (data[i, k] - data[j, k])**2
            dist[i, j] = np.sqrt(dist[i, j])
            dist[j, i] = dist[i, j]
    return dist
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">distancia_pares</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">distancia_pares_cython_inocente</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">timeit</span> -r3 -n1 distancia_pares(data)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4 s ± 24.2 ms per loop (mean ± std. dev. of 3 runs, 1 loop each)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">timeit</span> -r3 -n1 distancia_pares_numpy(data)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>45.5 ms ± 7.12 ms per loop (mean ± std. dev. of 3 runs, 1 loop each)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">timeit</span> -r3 -n1 distancia_pares_cython_inocente(data)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>3.39 s ± 24.3 ms per loop (mean ± std. dev. of 3 runs, 1 loop each)
</pre></div>
</div>
</div>
</div>
<p>El resultado es idéntico pero como no hemos hecho ningún cambio el tiempo de ejecución es sólo levemente mejor que la versión en Python puro</p>
<p>A continuación veremos como “cythonizar” nuestro código para ganar rendimiento</p>
</div>
<div class="section" id="mejora-1-definiendo-tipos-en-cython">
<h2><span class="section-number">4.3. </span>Mejora 1: Definiendo tipos en Cython<a class="headerlink" href="#mejora-1-definiendo-tipos-en-cython" title="Enlazar permanentemente con este título">¶</a></h2>
<p>En Cython se definen tipos estáticos con el keyword <code class="docutils literal notranslate"><span class="pre">cdef</span></code> seguido del tipo y luego el nombre. Por ejemplo una variable de tipo <code class="docutils literal notranslate"><span class="pre">double</span></code> llamada <code class="docutils literal notranslate"><span class="pre">mi_variable</span></code>:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">double</span> <span class="nf">mi_variable</span> 
</pre></div>
</div>
<p>Para los arreglos (ndarray) se usan <a class="reference external" href="https://cython.readthedocs.io/en/latest/src/userguide/memoryviews.html#memoryviews">“memory-views”</a>. Por ejemplo un <em>memory-view</em> para una arreglo de tres dimensiones:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">double</span> [<span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="n">mi_arreglo</span>
</pre></div>
</div>
<p>Y se puede ganar un poco más de rendimiento usando el operador <code class="docutils literal notranslate"><span class="pre">::1</span></code> para especificar si el arreglo es <em>row-major</em> (estilo C)</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">double</span> [<span class="p">:,</span> <span class="p">:,</span> <span class="p">::</span><span class="mf">1</span><span class="p">]</span> <span class="n">mi_arreglo</span>
</pre></div>
</div>
<p>o <em>column-major</em> (estilo Fortran)</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">double</span> [<span class="p">::</span><span class="mf">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="n">mi_arreglo</span>
</pre></div>
</div>
<p>Veamos como queda el ejemplo introduciendo tipos estáticos</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">cython</span> 

import numpy as np

def distancia_pares_cython_estatico(double [:, ::1] data):
    # Definimos el tipo de N, D, dist y data
    cdef int N = data.shape[0]
    cdef int D = data.shape[1]
    dist = np.empty(shape=(N, N), dtype=np.double)
    cdef double [:, ::1] dist_view = dist
    # También definimos los índices, se puede usar int o Py_ssize_t 
    cdef int i, j, k
    for i in range(N):
        for j in range(i, N):
            dist_view[i, j] = 0.0
            for k in range(D):
                dist_view[i, j] += (data[i, k] - data[j, k])**2
            dist_view[i, j] = np.sqrt(dist_view[i, j])
            dist_view[j, i] = dist_view[i, j]
    return dist
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">distancia_pares</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">distancia_pares_cython_estatico</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">timeit</span> -r3 -n1 distancia_pares_numpy(data) 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>47.3 ms ± 9.27 ms per loop (mean ± std. dev. of 3 runs, 1 loop each)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">timeit</span> -r3 -n1 distancia_pares_cython_estatico(data)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>601 ms ± 5.05 ms per loop (mean ± std. dev. of 3 runs, 1 loop each)
</pre></div>
</div>
</div>
</div>
<p>Con solo definir el tipo de data, dist, <span class="math notranslate nohighlight">\(N\)</span>, <span class="math notranslate nohighlight">\(D\)</span> y los índices hemos obtenido un <em>speed-up</em> importante con respecto a “Python puro” aunque sigue siendo más lento que NumPy</p>
<p>Si observaramos el código anotado por cython y revisemos la cantidad de llamadas a CPython de cada linea notaríamos que la linea 17 es particularmente conflictiva</p>
<ul class="simple">
<li><p>involucra una gran cantidad de instrucciones</p></li>
<li><p>se llama NxN veces</p></li>
</ul>
<p>esto se debe a que estamos usando la función de NumPy <code class="docutils literal notranslate"><span class="pre">np.sqrt</span></code>. Podemos obtener un rendimiento mucho mejor si usamos la implementación de raíz cuadrada de C</p>
</div>
<div class="section" id="mejora-2-llamando-funciones-de-c-desde-cython">
<h2><span class="section-number">4.4. </span>Mejora 2: Llamando funciones de C desde Cython<a class="headerlink" href="#mejora-2-llamando-funciones-de-c-desde-cython" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Es posible llamar funciones de C desde Cython de forma sencilla. Consideremos como ejemplo la función <code class="docutils literal notranslate"><span class="pre">sqrt</span></code> de la <a class="reference external" href="http://pubs.opengroup.org/onlinepubs/9699919799/basedefs/math.h.html">librería matemática estándar de C</a>.</p>
<p>Necesitamos dos para usar <code class="docutils literal notranslate"><span class="pre">sqrt</span></code> desde cython:</p>
<ul class="simple">
<li><p>Importar la función <code class="docutils literal notranslate"><span class="pre">sqrt</span></code> desde la cabecera <code class="docutils literal notranslate"><span class="pre">math.h</span></code>: Esto se hace con el keyword <code class="docutils literal notranslate"><span class="pre">cdef</span> <span class="pre">extern</span> <span class="pre">from</span></code></p></li>
<li><p>Compilar contra <code class="docutils literal notranslate"><span class="pre">libm</span></code></p></li>
</ul>
<p>Veamos como queda nuestro ejemplo con esta modificación</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">cython</span> -l m

import numpy as np

cdef extern from &quot;math.h&quot;:
    double sqrt(double)

def distancia_pares_cython_sqrtC(double [:, ::1] data):
    # Definimos el tipo de N, D, dist y data
    cdef int N = data.shape[0]
    cdef int D = data.shape[1]
    dist = np.empty(shape=(N, N), dtype=np.double)
    cdef double [:, ::1] dist_view = dist
    # También definimos los índices, se puede usar int o Py_ssize_t 
    cdef Py_ssize_t i, j, k
    for i in range(N):
        for j in range(i, N):
            dist_view[i, j] = 0.0
            for k in range(D):
                dist_view[i, j] += (data[i, k] - data[j, k])**2
            dist_view[i, j] = sqrt(dist_view[i, j])
            dist_view[j, i] = dist_view[i, j]
    return dist
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">distancia_pares</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">distancia_pares_cython_sqrtC</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">timeit</span> -r3 -n1 distancia_pares_numpy(data) 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>43.2 ms ± 1.33 ms per loop (mean ± std. dev. of 3 runs, 1 loop each)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">timeit</span> -r3 -n1 distancia_pares_cython_estatico(data)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>559 ms ± 8.39 ms per loop (mean ± std. dev. of 3 runs, 1 loop each)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">timeit</span> -r3 -n1 distancia_pares_cython_sqrtC(data)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>8.33 ms ± 777 µs per loop (mean ± std. dev. of 3 runs, 1 loop each)
</pre></div>
</div>
</div>
</div>
<p>Con esta simple modificación hemos obtenido un tiempo de ejecución incluso menor que la implementación en NumPy, excelente!</p>
<p>Es <strong>sumamente importante</strong> notar que usando <code class="docutils literal notranslate"><span class="pre">extern</span></code> podemos hacer interfaces <a class="reference external" href="https://cython.readthedocs.io/en/latest/src/tutorial/clibraries.html">entre Python y casi cualquier código escrito en C</a></p>
</div>
<div class="section" id="mejora-3-deshabilitando-comprobaciones-para-ir-aun-mas-rapido">
<h2><span class="section-number">4.5. </span>Mejora 3: Deshabilitando comprobaciones para ir aun más rápido<a class="headerlink" href="#mejora-3-deshabilitando-comprobaciones-para-ir-aun-mas-rapido" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Podemos hacer nuestro código más rápido (y más inseguro) deshabilitando las verificaciones que Python realiza por defecto</p>
<p>En Cython esto se logra usando decoradores que funcionan como directivas de compilación. Las opciones disponibles se encuentrán <a class="reference external" href="https://cython.readthedocs.io/en/latest/src/userguide/source_files_and_compilation.html#compiler-directives">aquí</a>. En este caso particular deshabilitaremos dos verificaciones: <em>boundscheck</em> y <em>wraparound</em></p>
<p>Al deshabilitarlas el código no comprobará si escribimos fuera del arreglo y tampoco traducirá índices negativos</p>
<p>También aprovecharemos de hacer un cambio menor que nos será de utilidad más adelante:</p>
<ul class="simple">
<li><p>Definiremos el tipo de data y dist de forma más conveniente usando <code class="docutils literal notranslate"><span class="pre">ctypedef</span></code></p></li>
<li><p>Para esto incluiremos un modulo de Cython llamado numpy usando <code class="docutils literal notranslate"><span class="pre">cimport</span></code> que contiene definiciones tipo C</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">cython</span> -l m
import cython
cimport numpy as npc
import numpy as np

# Por conveniencia podemos definir el tipo de data y dist con 
ctypedef npc.float64_t TIPO_t
TIPO = np.float64

cdef extern from &quot;math.h&quot;:
    TIPO_t sqrt(TIPO_t)

# Deshabilitamos las comprobaciones de Python:
@cython.boundscheck(False)
@cython.wraparound(False)
def distancia_pares_cython(TIPO_t [:, ::1] data):
    cdef int N = data.shape[0]
    cdef int M = data.shape[1]
    dist = np.empty(shape=(N, N), dtype=TIPO)
    cdef TIPO_t [:, ::1] dist_view = dist
    cdef Py_ssize_t i, j, k
    for i in range(N):
        for j in range(i, N):
            dist_view[i, j] = 0.0
            for k in range(M):
                dist_view[i, j] += (data[i, k] - data[j, k])**2
            dist_view[i, j] = sqrt(dist_view[i, j])
            dist_view[j, i] = dist_view[i, j]
    return dist
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">distancia_pares</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">distancia_pares_cython</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">timeit</span> -r3 -n1 distancia_pares_cython_sqrtC(data)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>10.4 ms ± 2.24 ms per loop (mean ± std. dev. of 3 runs, 1 loop each)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">timeit</span> -r3 -n1 distancia_pares_cython(data)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>10.1 ms ± 1.78 ms per loop (mean ± std. dev. of 3 runs, 1 loop each)
</pre></div>
</div>
</div>
</div>
<p>Un leve speed-up “casi gratis”</p>
</div>
<div class="section" id="mejora-4-mayor-flexibilidad-con-tipos-de-cython-fusionados">
<h2><span class="section-number">4.6. </span>Mejora 4: Mayor flexibilidad con tipos de Cython fusionados<a class="headerlink" href="#mejora-4-mayor-flexibilidad-con-tipos-de-cython-fusionados" title="Enlazar permanentemente con este título">¶</a></h2>
<p>En este momento es importante recordar lo que hemos perdido al usar Cython con respecto a Python: <strong>Flexibilidad</strong></p>
<p>Si usamos un argumento que no sea <code class="docutils literal notranslate"><span class="pre">double</span></code> nuestra función en Cython retornará un error. Es nuestra responsabilidad evitar que esto ocurra</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_float32</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">distancia_pares_cython</span><span class="p">(</span><span class="n">data_float32</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ValueError</span><span class="g g-Whitespace">                                </span>Traceback (most recent call last)
<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">25</span><span class="o">-</span><span class="n">acfad25fcfde</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="n">data_float32</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="ne">----&gt; </span><span class="mi">2</span> <span class="n">distancia_pares_cython</span><span class="p">(</span><span class="n">data_float32</span><span class="p">)</span>

<span class="nn">_cython_magic_76e28b0d12455c1590fdb682cea77a0c.pyx</span> in <span class="ni">_cython_magic_76e28b0d12455c1590fdb682cea77a0c.distancia_pares_cython</span><span class="nt">()</span>

<span class="ne">ValueError</span>: Buffer dtype mismatch, expected &#39;TIPO_t&#39; but got &#39;float&#39;
</pre></div>
</div>
</div>
</div>
<p>Podemos resolver este problema usando los tipos fusionados de Cython. Si queremos fusionar dos tipos de datos “tipo1” y “tipo2” bajo el nombre “tipo3”, lo escribimos usando</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">ctypedef</span> <span class="k">fused</span> <span class="n">tipo3</span><span class="p">:</span>
    <span class="n">tipo1</span>
    <span class="n">tipo2</span>
</pre></div>
</div>
<p>De forma transparente Cython creará dos funciones en lugar de una.</p>
<p>Modifiquemos la función <code class="docutils literal notranslate"><span class="pre">distancia_pares_cython</span></code> para que acepte los tipos double e float como un tipo fusionado. En este caso no debemos olvidar importar la definición de <code class="docutils literal notranslate"><span class="pre">sqrtf</span></code> de <code class="docutils literal notranslate"><span class="pre">math.h</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">cython</span> -l m
import cython
cimport numpy as npc
import numpy as np

# Tipo fusionado
ctypedef fused TIPO_t:
    npc.float32_t
    npc.float64_t # double
    
cdef extern from &quot;math.h&quot;:
    npc.float32_t sqrtf(npc.float32_t) #Definición para float32
    npc.float64_t sqrt(npc.float64_t) # Definición para float64

@cython.boundscheck(False)
@cython.wraparound(False)
def distancia_pares_cython_multitipo(TIPO_t [:, ::1] data):
    cdef int N = data.shape[0]
    cdef int M = data.shape[1]
    # Comprobamos el tipo antes de crear el arreglo de numpy
    if TIPO_t is npc.float32_t:
        TIPO = np.float32
    else:
        TIPO = np.float64
    dist = np.empty(shape=(N, N), dtype=TIPO)
    cdef TIPO_t [:, ::1] dist_view = dist
    cdef Py_ssize_t i, j, k
    for i in range(N):
        for j in range(N):
            dist_view[i, j] = 0.0
            for k in range(M):
                dist_view[i, j] += (data[i, k] - data[j, k])**2
            if TIPO_t is npc.float32_t:
                dist_view[i, j] = sqrtf(dist_view[i, j])
            else:
                dist_view[i, j] = sqrt(dist_view[i, j])
    return dist
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">distancia_pares_numpy</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
            <span class="n">distancia_pares_cython_multitipo</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">distancia_pares_numpy</span><span class="p">(</span><span class="n">data_float32</span><span class="p">),</span>
            <span class="n">distancia_pares_cython_multitipo</span><span class="p">(</span><span class="n">data_float32</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">timeit</span> -r3 -n1 distancia_pares_numpy(data_float32)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>35.1 ms ± 487 µs per loop (mean ± std. dev. of 3 runs, 1 loop each)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">timeit</span> -r3 -n1 distancia_pares_cython_multitipo(data_float32)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>8.47 ms ± 1.23 ms per loop (mean ± std. dev. of 3 runs, 1 loop each)
</pre></div>
</div>
</div>
</div>
<p>El resultado usando <code class="docutils literal notranslate"><span class="pre">float</span></code> es equivalente al de NumPy y la velocidad es similar a la de <code class="docutils literal notranslate"><span class="pre">distancia_pares_cython</span></code>, es decir que la pérdida de rendimiento no es notoria</p>
</div>
<div class="section" id="ejemplo-formativo-cythonizando-el-fractal-de-julia">
<h2><span class="section-number">4.7. </span>Ejemplo formativo: “Cythonizando” el fractal de Julia<a class="headerlink" href="#ejemplo-formativo-cythonizando-el-fractal-de-julia" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Partiendo del código de Python puro del fractal de Julia, escribimos una versión en Cython</p>
<p>Recordemos:</p>
<ul class="simple">
<li><p>Usamos <code class="docutils literal notranslate"><span class="pre">cdef</span></code> para definir las variables con tipo estático</p>
<ul>
<li><p>También podemos usar <code class="docutils literal notranslate"><span class="pre">cdef</span></code> para definir funciones con tipo</p></li>
<li><p>Las funciones con tipo solo pueden ser llamadas por otras funciones de Cython</p></li>
</ul>
</li>
<li><p>Usamos <code class="docutils literal notranslate"><span class="pre">ctypedef</span></code> para definir tipos</p></li>
<li><p>Usamos <code class="docutils literal notranslate"><span class="pre">cimport</span></code> para importar otros módulos de Cython</p></li>
<li><p>Usamos memory-views con el tipo adecuado para conectar con NumPy en la salida</p></li>
<li><p>Deshabilitamos las comprobaciones de Python para ganar más velocidad</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">cython</span> 
import cython
cimport numpy as npc
import numpy as np

ctypedef npc.float64_t TIPOF_t
ctypedef npc.int64_t TIPOI_t

# Las funciones con cdef solo pueden ser llamadas desde Cython
cdef TIPOI_t evaluate_z(TIPOF_t zi, TIPOF_t zr, int maxiters=50, TIPOF_t cr=-0.835, TIPOF_t ci=-0.2321):
    cdef:
        TIPOI_t nit = 0
        TIPOF_t zi2 = zi**2
        TIPOF_t zr2 = zr**2
        
    while zi2 + zr2 &lt;= 4. and nit &lt; maxiters:
        zi = 2.*zr*zi + ci
        zr = zr2 - zi2 + cr
        zr2 = zr**2
        zi2 = zi**2 
        nit +=1
    return nit

# Las funciones con def pueden ser llamadas desde Python
@cython.boundscheck(False)
@cython.wraparound(False)
@cython.cdivision(True)
def make_fractal_cython(int N, int maxiters=50):
    image = np.empty(shape=(N, 2*N), dtype=np.int64)
    cdef TIPOI_t [:, ::1] image_view = image
    cdef:
        Py_ssize_t i, j
    # Los ndarray no se copian, los podemos modificar inplace desde Cython
    for i in range(N):
        for j in range(2*N):
            image_view[i, j] = evaluate_z(-1.+i*2./N, -2.+j*2./N, maxiters)
    return image
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">fractal</span> <span class="kn">import</span> <span class="n">make_fractal</span>
<span class="n">N</span> <span class="o">=</span> <span class="mi">500</span>
<span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">make_fractal</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="n">make_fractal_cython</span><span class="p">(</span><span class="n">N</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">timeit</span> -r3 -n1 make_fractal(N)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.29 s ± 19.6 ms per loop (mean ± std. dev. of 3 runs, 1 loop each)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">timeit</span> -r3 -n1 make_fractal_cython(N)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>19.8 ms ± 72 µs per loop (mean ± std. dev. of 3 runs, 1 loop each)
</pre></div>
</div>
</div>
</div>
<p>El resultado es idéntico al código secuencial en “Python puro” y el tiempo es considerablemente menor</p>
<p>Con esto podemos dibujar el fractal en mayor resolución en un tiempo razonable :)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">N</span> <span class="o">=</span> <span class="mi">4000</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">make_fractal_cython</span><span class="p">(</span><span class="n">N</span><span class="p">));</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/HPC4_54_0.png" src="../../../_images/HPC4_54_0.png" />
</div>
</div>
<p><strong>Propuesto:</strong></p>
<p>Dibuje curvas de <em>speed-up</em> para el código en cython vs “Python puro” considerando <span class="math notranslate nohighlight">\(N=10, 50, 100, 500, 1000, 5000\)</span></p>
</div>
<div class="section" id="topicos-adicionales">
<h2><span class="section-number">4.8. </span>Tópicos adicionales<a class="headerlink" href="#topicos-adicionales" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Lecturas sobre temas específicos de Cython:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://cython.readthedocs.io/en/latest/src/quickstart/build.html#building-a-cython-module-using-distutils">Incluyendo código Cython en un módulo de Python</a></p></li>
<li><p><a class="reference external" href="https://cython.readthedocs.io/en/latest/src/tutorial/profiling_tutorial.html">Haciendo profiling de código Cython</a></p></li>
<li><p><a class="reference external" href="https://cython.readthedocs.io/en/latest/src/tutorial/memory_allocation.html">Malloc/Free en Cython</a></p></li>
<li><p>Libro <a class="reference external" href="https://pythonbooks.org/cython-a-guide-for-python-programmers/">Cython: A Guide for Python Programmers</a></p></li>
</ul>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./clases/unidad3/2_HPC"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
        <div class='prev-next-bottom'>
            
    <a class='left-prev' id="prev-link" href="HPC3.html" title="previous page"><span class="section-number">3. </span>Optimizando código Python</a>
    <a class='right-next' id="next-link" href="HPC5.html" title="next page"><span class="section-number">5. </span>Computación paralela en Python</a>

        </div>
        
        </div>
    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          Por Pablo Huijse Heise<br/>
        
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>

    
  <script src="../../../_static/js/index.d3f166471bb80abb5163.js"></script>


    
  </body>
</html>